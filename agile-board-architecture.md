# Architecture du Plugin Agile Board

Ce document pr√©sente l'architecture et les relations entre les diff√©rents fichiers de la codebase du plugin Agile Board pour Obsidian.

## Diagramme d'Architecture

```mermaid
flowchart TD
    %% L√©gende int√©gr√©e
    subgraph LEGEND [" üìñ L√âGENDE DES COULEURS "]
        CORE_LEG["üîµ **CORE**
        Services fondamentaux"]
        SERVICE_LEG["üü£ **SERVICES**
        Logique m√©tier"]
        RENDER_LEG["üü¢ **RENDU**
        Interface visuelle"]
        VIEW_LEG["üü† **VUES**
        Vues sp√©cialis√©es"]
        TYPE_LEG["ü©∑ **TYPES**
        D√©finitions communes"]
    end

    %% Plugin principal
    A["main.ts
üîß Class: AgileBoardPlugin
    - onload()
    - onunload()
    - initializeServices()
    - startMonitoring()
    - cleanup()"] --> B["layoutService.ts
‚öôÔ∏è Class: LayoutService
    - load()
    - getModel()
    - hasModel()
    - getAllModelNames()
    - reload()"]
    A --> C["modelDetector.ts
üëÅÔ∏è Class: ModelDetector
    - handleFileOpen()
    - extractModelName()
    - attemptAutoSwitch()
    - markUserManualChange()
    - resetManualChanges()"]
    A --> D["agileBoardView.ts
üìã Class: AgileBoardView
    - renderBoardLayout()
    - createFrames()
    - onFrameContentChanged()
    - switchToNormalView()
    - createMissingSections()"]
    A --> E["viewSwitcher.ts
üîÑ Class: ViewSwitcher
    - switchToBoardView()
    - switchToMarkdownView()
    - addSwitchButton()
    - updateSwitchButton()
    - observeToolbarChanges()"]
    A --> F["fileSynchronizer.ts
üîÑ Class: FileSynchronizer
    - start()
    - stop()
    - onFileModified()
    - updateBoardView()
    - notifyBoardViewChange()"]
    A --> G["core/index.ts
üì¶ Class: Core Exports"]

    %% Services Layout
    B --> H["core/layout/layoutLoader.ts
üì• Class: LayoutLoader
    - loadLayouts()
    - loadIndividualLayouts()"]
    B --> I["core/errorHandler.ts
‚ùå Class: ErrorHandler
    - handleError()
    - displayToUser()
    - logError()"]
    B --> J["core/validation.ts
‚úÖ Class: ValidationUtils
    - validateLayoutModel()
    - validateLayoutModelName()
    - checkGridCollisions()"]
    B --> HH1["core/layout/layoutFileRepo.ts
üìÅ Class: LayoutFileRepo
    - listLayouts()
    - loadLayout()
    - saveLayout()
    - deleteLayout()
    - watchFiles()"]
    B --> II1["ui/layoutSettingsTab.ts
‚öôÔ∏è Class: LayoutSettingsTab
    - display()
    - refreshLayoutList()
    - openLayoutEditor()"]
    A --> LL1["settings.ts
‚öôÔ∏è Class: AgileBoardSettings
    - loadSettings()
    - saveSettings()
    - getDefaults()"]
    A --> MM1["settingsTab.ts
üîß Class: SettingsTab
    - display()
    - addGeneralSettings()
    - addLayoutSettings()"]
    
    C --> B
    
    %% Rendu
    D --> K["layoutRenderer.ts
üé® Class: LayoutRenderer
    - renderLayout()
    - findMissingSections()
    - renderErrorOverlay()
    - resetAndInsertSections()
    - isLivePreviewMode()"]
    D --> L["sectionParser.ts
üìù Class: SectionParser
    - parseMarkdownSections()
    - extractLevelOneTitle()
    - validateRequiredSections()
    - insertMissingSections()
    - parseHeadingsInFile()"]
    K --> L
    K --> M["markdownBox.ts
‚úèÔ∏è Class: MarkdownBox
    - renderPreview()
    - openEditor()
    - closeEditor()
    - isInteractiveElement()"]
    
    %% Vues sp√©cialis√©es
    D --> N["nativeMarkdownView.ts
üìÑ Class: NativeMarkdownView"]
    D --> O["embeddedMarkdownView.ts
üîó Class: EmbeddedMarkdownView"]
    D --> P["markdownSubView.ts
üìë Class: MarkdownSubView"]
    D --> Q["simpleMarkdownFrame.ts
üñºÔ∏è Class: SimpleMarkdownFrame"]

    %% Nouveaux Composants Modulaires - Refactoring v0.7.7+
    Q --> QQ1["components/markdown/MarkdownRenderer.ts
üìù Class: MarkdownRenderer
    - render()
    - setupObsidianIntegration()"]
    Q --> QQ2["components/markdown/MarkdownEditor.ts
‚úèÔ∏è Class: MarkdownEditor
    - initialize()
    - focus()
    - handleEnterKey()
    - unload()"]
    Q --> QQ3["components/markdown/LinkHandler.ts
üîó Class: LinkHandler
    - setupAllLinks()
    - isInteractiveElement()
    - handleUniversalLink()"]
    Q --> QQ4["components/markdown/CheckboxHandler.ts
‚òëÔ∏è Class: CheckboxHandler
    - setupCheckboxHandlers()
    - updateMarkdownContent()
    - saveChanges()"]
    Q --> QQ5["components/markdown/GridLayoutManager.ts
üìê Class: GridLayoutManager
    - convertToAbsolute()
    - restoreToGrid()
    - preserveDimensions()"]

    KK1 --> RR1["components/editor/GridCanvas.ts
üé® Class: GridCanvas
    - createGrid()
    - screenToGrid()
    - getCellSize()"]
    KK1 --> RR2["components/editor/BoxManager.ts
üì¶ Class: BoxManager
    - createBoxElement()
    - updateBoxPosition()
    - generateBoxId()
    - validateLayout()"]
    KK1 --> RR3["components/editor/DragDropHandler.ts
üéØ Class: DragDropHandler
    - startGridDrag()
    - startBoxDrag()
    - startResizeDrag()
    - calculateDimensions()"]
    KK1 --> RR4["components/editor/SelectionManager.ts
üéØ Class: SelectionManager
    - selectBox()
    - deselectAll()
    - generateSelectionInfo()"]
    KK1 --> RR5["components/editor/Sidebar.ts
üéõÔ∏è Class: Sidebar
    - createSidebar()
    - updateSelectionInfo()
    - setupTitleInputHandlers()"]

    %% Core syst√®me
    G --> I
    G --> R["core/logger.ts
üìä Class: Logger
    - createContextLogger()
    - info()
    - debug()
    - error()
    - warn()"]
    G --> S["core/lifecycle.ts
üîÑ Class: LifecycleManager
    - registerComponent()
    - initializeComponents()
    - dispose()"]
    G --> J
    G --> T["core/logging-config.ts
‚öôÔ∏è Class: LoggingConfig
    - setupAutomatic()
    - addLogLevelCommands()
    - setLogLevel()"]
    G --> U["core/baseComponent.ts
üèóÔ∏è Class: BaseComponent
    - onLoad()
    - onUnload()"]
    
    H --> V["core/layout/layoutValidator.ts
‚úÖ Class: LayoutValidator
    - validateModel()
    - validateBlock()
    - checkBounds()"]
    HH1 --> JJ1["core/layout/layoutValidator24.ts
‚úÖ Class: LayoutValidator24
    - validateLayout()
    - wouldCollide()
    - findFreePosition()"]
    II1 --> KK1["ui/layoutEditor.ts
üé® Class: LayoutEditor
    - setupUI()
    - renderLayout()
    - createBoxElement()
    - handleDrag()
    - saveLayout()"]
    
    %% DOM
    G --> W["core/dom/index.ts
üåê Class: DOM Exports"]
    W --> X["core/dom/elementFactory.ts
üè≠ Class: ElementFactory
    - createElement()
    - createContainer()"]
    W --> Y["core/dom/dimensionManager.ts
üìè Class: DimensionManager
    - calculateDimensions()
    - getGridPosition()"]
    
    %% Composants
    G --> Z["core/components/index.ts
üß© Class: Components Exports"]
    Z --> AA["core/components/markdownEditor.ts
‚úèÔ∏è Class: MarkdownEditor
    - initialize()
    - updateContent()"]
    Z --> BB["core/components/markdownPreview.ts
üëÅÔ∏è Class: MarkdownPreview
    - render()
    - refresh()"]
    Z --> CC["core/components/embedRenderer.ts
üîó Class: EmbedRenderer
    - renderEmbed()
    - handleLinks()"]
    Z --> DD["core/components/taskManager.ts
üìã Class: TaskManager
    - createTask()
    - updateTask()"]
    
    %% Business
    G --> EE["core/business/index.ts
üíº Class: Business Exports"]
    EE --> FF["core/business/markdownProcessor.ts
‚öôÔ∏è Class: MarkdownProcessor
    - processContent()
    - extractMetadata()"]
    EE --> GG["core/business/gridCalculator.ts
üìê Class: GridCalculator
    - calculateGridLayout()
    - optimizePositions()"]
    
    %% Types
    HH["types.ts
üìã Class: Type Definitions
    - LayoutModel
    - SectionInfo
    - PluginError
    - ValidationResult
    - FileDetectionState"] -.-> A
    HH -.-> B
    HH -.-> C
    HH -.-> K
    HH -.-> L
    HH -.-> H
    HH -.-> V

    %% Styles pour les couches
    classDef coreLayer fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef serviceLayer fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef renderLayer fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef viewLayer fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef typeLayer fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef legendStyle fill:#f8f9fa,stroke:#6c757d,stroke-width:1px

    %% Application des styles
    class A,G,I,R,S,J,T,U,W,X,Y,Z,AA,BB,CC,DD,EE,FF,GG,LL1 coreLayer
    class B,C,E,F,H,V,HH1,JJ1 serviceLayer
    class K,M,KK1,QQ1,QQ2,QQ3,QQ4,QQ5,RR1,RR2,RR3,RR4,RR5 renderLayer
    class D,N,O,P,Q,II1,MM1 viewLayer
    class HH,L typeLayer
    class LEGEND,CORE_LEG,SERVICE_LEG,RENDER_LEG,VIEW_LEG,TYPE_LEG legendStyle
```

## L√©gende des Couleurs

| Couleur | Couche | Description |
|---------|--------|-------------|
| üîµ **Bleu** | **Core** | Services fondamentaux (logging, erreurs, validation, DOM) |
| üü£ **Violet** | **Services** | Logique m√©tier (layout, d√©tection, synchronisation) |
| üü¢ **Vert** | **Rendu** | Interface visuelle (renderer, √©diteur inline) |
| üü† **Orange** | **Vues** | Vues Obsidian sp√©cialis√©es (Board, Markdown) |
| ü©∑ **Rose** | **Types** | D√©finitions communes (types, parsing) |

## Description des Composants Principaux

### üîß Plugin Principal (A)
- **main.ts** - Point d'entr√©e orchestrant tous les services
- M√©thodes cl√©s : `onload()`, `initializeServices()`, `startMonitoring()`

### ‚öôÔ∏è Services M√©tier (B-F, H, V, HH1, JJ1)
- **LayoutService (B)** - Gestion des mod√®les de layout
- **ModelDetector (C)** - D√©tection automatique des fichiers avec layout
- **AgileBoardView (D)** - Vue principale du plugin
- **ViewSwitcher (E)** - Basculement entre vues Board et Markdown
- **FileSynchronizer (F)** - Synchronisation en temps r√©el
- **LayoutLoader (H)** - Chargement depuis fichiers individuels `/layouts/`
- **LayoutValidator (V)** - Validation des mod√®les (legacy)
- **LayoutFileRepo (HH1)** - Repository pour gestion CRUD des layouts
- **LayoutValidator24 (JJ1)** - Validation optimis√©e grille 24x24

### üé® Rendu et Interface (K, M, KK1)
- **LayoutRenderer (K)** - Rendu de la grille visuelle
- **MarkdownBox (M)** - Composant d'√©dition inline avec pr√©visualisation
- **LayoutEditor (KK1)** - √âditeur visuel drag & drop pour cr√©er/modifier layouts

### üèóÔ∏è Infrastructure Core (G, I, R, S, J, T-GG, LL1)
- **ErrorHandler (I)** - Gestion centralis√©e des erreurs
- **Logger (R)** - Syst√®me de logging contextualis√©
- **LifecycleManager (S)** - Gestion du cycle de vie des composants
- **ValidationUtils (J)** - Utilitaires de validation
- **DOM Factory (X)** - Cr√©ation d'√©l√©ments DOM
- **Business Logic (FF, GG)** - Processeurs et calculateurs m√©tier
- **AgileBoardSettings (LL1)** - Syst√®me de configuration du plugin

### üìã Types et Utilitaires (HH, L)
- **types.ts (HH)** - D√©finitions TypeScript communes
- **sectionParser.ts (L)** - Parsing des sections Markdown

### üñºÔ∏è Vues Sp√©cialis√©es (N-Q, II1, MM1)
- **NativeMarkdownView (N-Q)** - Diff√©rentes impl√©mentations de vues Markdown
- **LayoutSettingsTab (II1)** - Onglet param√®tres pour gestion des layouts
- **SettingsTab (MM1)** - Interface de configuration g√©n√©rale du plugin

### üß© Composants Modulaires - Architecture Refactoris√©e (QQ1-QQ5, RR1-RR5)

#### **Composants Markdown (QQ1-QQ5)**
- **MarkdownRenderer (QQ1)** - Rendu pur avec int√©gration API Obsidian
- **MarkdownEditor (QQ2)** - √âdition textarea avec continuation automatique des listes
- **LinkHandler (QQ3)** - Gestion universelle des liens (Dataview/Tasks/Obsidian)
- **CheckboxHandler (QQ4)** - Synchronisation bidirectionnelle checkboxes ‚Üî markdown
- **GridLayoutManager (QQ5)** - Conversion CSS grid ‚Üî positionnement absolu pendant √©dition

#### **Composants √âditeur (RR1-RR5)**
- **GridCanvas (RR1)** - Rendu grille 24x24 pure avec num√©rotation et guides visuels
- **BoxManager (RR2)** - CRUD des boxes avec validation anti-collision en temps r√©el
- **DragDropHandler (RR3)** - Machine d'√©tat pour interactions drag/resize/create
- **SelectionManager (RR4)** - Gestion s√©lection avec feedback visuel et info panneau
- **Sidebar (RR5)** - Interface contr√¥les, param√®tres et informations contextuelles

## üöÄ Points d'Entr√©e Principaux

1. **main.ts** - Point d'entr√©e du plugin, orchestre tous les services via `onload()`
2. **agileBoardView.ts** - Vue principale qui g√®re l'affichage des boards via `renderBoardLayout()`
3. **layoutService.ts** - Service central de gestion des layouts via `load()` et `getModel()`
4. **modelDetector.ts** - D√©tection automatique des notes avec layouts via `handleFileOpen()`

## üîÑ Flux de Donn√©es D√©taill√©

### 1. **Initialisation** (üîß main.ts)
```
onload() ‚Üí initializeServices() ‚Üí startMonitoring()
‚îú‚îÄ‚îÄ AgileBoardSettings.loadSettings() - Charge la configuration
‚îú‚îÄ‚îÄ LayoutService.load() - Charge layouts depuis /layouts/
‚îú‚îÄ‚îÄ ModelDetector.onLoad() - Active la surveillance
‚îú‚îÄ‚îÄ ViewSwitcher.addSwitchButton() - Ajoute boutons
‚îî‚îÄ‚îÄ FileSynchronizer.start() - Lance sync fichiers
```

### 2. **D√©tection Automatique** (üëÅÔ∏è ModelDetector)
```
Fichier ouvert ‚Üí handleFileOpen()
‚îú‚îÄ‚îÄ extractModelName() - Lit frontmatter agile-board
‚îú‚îÄ‚îÄ shouldAutoSwitch() - V√©rifie conditions
‚îî‚îÄ‚îÄ attemptAutoSwitch() - Bascule vers Board View
```

### 3. **Rendu Board** (üìã AgileBoardView)
```
renderBoardLayout()
‚îú‚îÄ‚îÄ LayoutService.getModel() - R√©cup√®re mod√®le
‚îú‚îÄ‚îÄ parseHeadingsInFile() - Parse sections
‚îú‚îÄ‚îÄ createGrid() - Cr√©e grille CSS
‚îî‚îÄ‚îÄ createFrames() - Cr√©e frames √©ditables
```

### 4. **√âdition Inline** (‚úèÔ∏è MarkdownBox)
```
Clic ‚Üí openEditor()
‚îú‚îÄ‚îÄ User Edit ‚Üí input event
‚îú‚îÄ‚îÄ renderPreview() - Live preview
‚îî‚îÄ‚îÄ closeEditor() ‚Üí onChange() ‚Üí FileSynchronizer
```

### 5. **Synchronisation** (üîÑ FileSynchronizer)
```
Fichier modifi√© ‚Üí onFileModified()
‚îú‚îÄ‚îÄ getBoardViewForFile() - Trouve vue Board
‚îú‚îÄ‚îÄ parseHeadingsInFile() - Parse nouveau contenu
‚îî‚îÄ‚îÄ updateBoardView() - Met √† jour frames
```

### 6. **Gestion des Layouts** (‚öôÔ∏è LayoutSettingsTab)
```
Param√®tres ‚Üí LayoutSettingsTab.display()
‚îú‚îÄ‚îÄ listLayouts() - Liste layouts disponibles
‚îú‚îÄ‚îÄ openLayoutEditor() - Ouvre √©diteur visuel
‚îú‚îÄ‚îÄ LayoutEditor.setupUI() - Interface drag & drop
‚îú‚îÄ‚îÄ saveLayout() - Sauvegarde layout.json individuel
‚îî‚îÄ‚îÄ LayoutFileRepo.watchFiles() - Hot-reload
```

### 7. **Cr√©ation/√âdition Visuelle** (üé® LayoutEditor)
```
Nouveau Layout ‚Üí LayoutEditor.onOpen()
‚îú‚îÄ‚îÄ setupGrid() - Grille 24x24 avec num√©rotation
‚îú‚îÄ‚îÄ createBoxElement() - Cr√©er/modifier boxes
‚îú‚îÄ‚îÄ handleDrag() - Drag & drop + redimensionnement
‚îú‚îÄ‚îÄ LayoutValidator24.validateLayout() - Validation en temps r√©el
‚îî‚îÄ‚îÄ saveLayout() - G√©n√®re fichier /layouts/nom.json
```

## üèóÔ∏è Refactoring Modulaire v0.7.7+ (SOLID Principles)

### **Refactoring SimpleMarkdownFrame (922 ‚Üí 277 lignes, -70%)**
**Probl√®me** : Classe monolithique avec trop de responsabilit√©s
**Solution** : Division en 5 composants sp√©cialis√©s suivant SOLID

```
SimpleMarkdownFrame (refactoris√©)
‚îú‚îÄ‚îÄ MarkdownRenderer (QQ1) - Rendu pur avec API Obsidian
‚îú‚îÄ‚îÄ MarkdownEditor (QQ2) - √âdition textarea avec continuation listes
‚îú‚îÄ‚îÄ LinkHandler (QQ3) - Gestion liens universelle (Dataview/Tasks)
‚îú‚îÄ‚îÄ CheckboxHandler (QQ4) - Synchronisation checkboxes ‚Üî markdown
‚îî‚îÄ‚îÄ GridLayoutManager (QQ5) - Conversion CSS grid ‚Üî positionnement absolu
```

**Architecture SOLID appliqu√©e** :
- ‚úÖ **Single Responsibility** : Chaque composant a une responsabilit√© claire
- ‚úÖ **Dependency Injection** : Composants re√ßoivent d√©pendances via constructeurs
- ‚úÖ **Interface Segregation** : Interfaces focalis√©es et minimales

### **Refactoring LayoutEditor (1471 ‚Üí 550 lignes, -63%)**
**Probl√®me** : Modal drag & drop massive et difficile √† maintenir
**Solution** : Architecture modulaire avec gestion d'√©tat s√©par√©e

```
LayoutEditor (refactoris√©)
‚îú‚îÄ‚îÄ GridCanvas (RR1) - Rendu grille 24x24 pure avec num√©rotation
‚îú‚îÄ‚îÄ BoxManager (RR2) - CRUD boxes + validation anti-collision
‚îú‚îÄ‚îÄ DragDropHandler (RR3) - Machine d'√©tat drag/resize/create
‚îú‚îÄ‚îÄ SelectionManager (RR4) - Gestion s√©lection + feedback visuel
‚îî‚îÄ‚îÄ Sidebar (RR5) - Contr√¥les interface + panneau param√®tres
```

**Patterns appliqu√©s** :
- üéØ **State Machine** : DragDropHandler g√®re √©tats drag/resize/create
- üîß **Repository Pattern** : BoxManager encapsule CRUD des boxes
- üé® **Pure Components** : GridCanvas sans effets de bord
- üìä **Observer Pattern** : SelectionManager notifie changements

### **B√©n√©fices du Refactoring**
- üìà **Maintenabilit√©** : Composants <300 lignes, faciles √† comprendre
- üß™ **Testabilit√©** : Fonctions pures et composants isol√©s
- üîÑ **R√©utilisabilit√©** : Composants modulaires r√©utilisables
- üêõ **Debugging** : Responsabilit√©s claires facilitent d√©bogage
- üìö **Documentation** : Architecture auto-document√©e

### **Migration sans Breaking Changes**
- ‚úÖ **API pr√©serv√©e** : Interfaces publiques inchang√©es
- ‚úÖ **Fonctionnalit√©s** : 100% des features maintenues
- ‚úÖ **Performance** : Am√©lioration gr√¢ce √† architecture optimis√©e
- ‚úÖ **Stabilit√©** : Moins de bugs avec s√©paration concerns

## üéØ Interactions Cl√©s

**üîÑ Cycle Principal**
- **Configuration** : AgileBoardSettings g√®re les pr√©f√©rences utilisateur
- **D√©tection** : ModelDetector surveille les fichiers et frontmatter
- **Basculement** : ViewSwitcher g√®re les transitions entre vues
- **Rendu** : LayoutRenderer + MarkdownBox affichent la grille √©ditable
- **Synchronisation** : FileSynchronizer maintient la coh√©rence
- **Gestion Layouts** : LayoutFileRepo + LayoutEditor permettent CRUD visuel

**‚ö° √âv√©nements Temps R√©el**
- Modification fichier ‚Üí Mise √† jour automatique des frames
- Changement frontmatter ‚Üí Re-d√©tection du mod√®le
- √âdition inline ‚Üí Sauvegarde imm√©diate + sync autres vues
- Cr√©ation/modification layout ‚Üí Hot-reload automatique
- Drag & drop dans √©diteur ‚Üí Validation en temps r√©el des collisions

**üé® Nouveaut√©s Architecture**
- **Syst√®me de fichiers individuels** : Chaque layout = 1 fichier `/layouts/nom.json`
- **√âditeur visuel drag & drop** : Cr√©ation/modification layouts sans code
- **Validation grille 24x24** : Pr√©vention collisions + optimisation positions
- **Hot-reload layouts** : Modifications prises en compte instantan√©ment
- **Interface de gestion** : CRUD layouts via onglet param√®tres d√©di√©

**üèóÔ∏è Refactoring Majeur v0.7.7+ (SOLID)**
- **Architecture modulaire** : 10 nouveaux composants sp√©cialis√©s (1600+ lignes supprim√©es)
- **Principes SOLID appliqu√©s** : Single responsibility, dependency injection, s√©paration concerns
- **SimpleMarkdownFrame refactoris√©** : 922‚Üí277 lignes (-70%) en 5 composants markdown
- **LayoutEditor refactoris√©** : 1471‚Üí550 lignes (-63%) en 5 composants √©diteur
- **Migration transparente** : 0 breaking changes, 100% fonctionnalit√©s pr√©serv√©es
- **Am√©lioration maintenance** : Code plus lisible, testable et r√©utilisable

---

*Mis √† jour apr√®s le refactoring modulaire majeur v0.7.7+ - Architecture SOLID compl√®te*